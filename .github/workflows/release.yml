name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        name: Build Release
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      goos: linux
                      goarch: amd64
                      suffix: ""
                    - os: ubuntu-latest
                      goos: linux
                      goarch: arm64
                      suffix: ""
                    - os: macos-latest
                      goos: darwin
                      goarch: amd64
                      suffix: ""
                    - os: macos-latest
                      goos: darwin
                      goarch: arm64
                      suffix: ""
                    - os: windows-latest
                      goos: windows
                      goarch: amd64
                      suffix: ".exe"

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Build binary
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  go build -v \
                    -ldflags="-X main.Version=${{ github.ref_name }}" \
                    -o bin/instagram-media-insights-go-client-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }} \
                    ./cmd/main/main.go

            - name: Calculate checksum
              run: |
                  cd bin
                  sha256sum instagram-media-insights-go-client-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }} > instagram-media-insights-go-client-${{ matrix.goos }}-${{ matrix.goarch }}.sha256
                  cat instagram-media-insights-go-client-${{ matrix.goos }}-${{ matrix.goarch }}.sha256

            - name: Upload artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: binaries
                  path: bin/instagram-media-insights-go-client-*

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download artifacts
              uses: actions/download-artifact@v3
              with:
                  name: binaries
                  path: ./bin

            - name: Generate changelog
              id: changelog
              run: |
                  if [ -f CHANGELOG.md ]; then
                    echo "## Release ${{ github.ref_name }}" > release_notes.md
                    sed -n '/^## /,/^## /p' CHANGELOG.md | head -n -1 >> release_notes.md
                  else
                    echo "## Release ${{ github.ref_name }}" > release_notes.md
                    echo "" >> release_notes.md
                    echo "See commit history for changes." >> release_notes.md
                  fi

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: bin/instagram-media-insights-go-client-*
                  body_path: release_notes.md
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
